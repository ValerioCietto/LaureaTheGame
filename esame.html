<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Esame dinamico</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 40px auto;
      line-height: 1.5;
    }
    h1, h2 {
      text-align: center;
    }
    #exam-text p {
      background: #f0f8ff;
      padding: 10px;
      border-left: 4px solid #268bd2;
      margin: 0 0 1em;
    }
    .question {
      margin-bottom: 1.2em;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .options label {
      display: block;
      margin: 4px 0;
    }
    #submit-button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1em;
    }
    #result {
      text-align: center;
      font-size: 1.2em;
      margin-top: 30px;
      padding: 20px;
      border: 2px solid #268bd2;
      border-radius: 8px;
      background: #eef9ff;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h1 id="exam-title">Esame</h1>
  <p style="text-align:center;">
    CFU assegnati: <span id="cfu-display">–</span> &nbsp;|&nbsp;
    Preparazione: <span id="prep-display">–</span> paragrafi
  </p>

  <div id="exam-text"></div>

  <form id="exam-form"></form>
  <button id="submit-button">Invia risposte</button>

  <div id="result" style="display:none;"></div>

  <script>
    // Helper: estrai parametro numerico o stringa
    function getParam(name, defaultValue = null) {
      const params = new URL(window.location).searchParams;
      return params.has(name) ? params.get(name) : defaultValue;
    }
    function getParamNum(name, defaultValue) {
      const v = parseInt(getParam(name), 10);
      return isNaN(v) ? defaultValue : v;
    }

    // Fisher–Yates shuffle
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const nomeEsame = getParam('nome_esame', null);
      if (!nomeEsame) {
        document.body.innerHTML = "<p style='color:red;text-align:center;'>Parametro <strong>nome_esame</strong> mancante!</p>";
        return;
      }

      let examData;
      try {
        const res = await fetch(`esami/${nomeEsame}.json`);
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        examData = await res.json();
      } catch (err) {
        document.body.innerHTML = `<p style='color:red;text-align:center;'>Impossibile caricare l'esame "${nomeEsame}":<br>${err.message}</p>`;
        return;
      }

      // Parametri
      const prep = Math.min(4, Math.max(1, getParamNum('preparazione', 1)));
      const cfuParam = getParamNum('cfu', examData.cfu || 0);
      examData.cfu = cfuParam;

      // Titolo e CFU/preparazione
      document.getElementById('exam-title').innerText = `Esame: ${examData.name}`;
      document.getElementById('cfu-display').innerText = examData.cfu;
      document.getElementById('prep-display').innerText = prep;

      // Mostra paragrafi sbloccati
      const textContainer = document.getElementById('exam-text');
      examData.text.slice(0, prep).forEach(p => {
        const pEl = document.createElement('p');
        pEl.textContent = p;
        textContainer.appendChild(pEl);
      });

      // Seleziona 5 domande (assumiamo esame da 6 CFU; per altri CFU cambiare slice)
      const selected = shuffle([...examData.questions]).slice(0, 5);

      // Popola form
      const form = document.getElementById('exam-form');
      selected.forEach((q, idx) => {
        const field = document.createElement('div');
        field.className = 'question';
        field.innerHTML = `
          <h2>Domanda ${idx + 1}</h2>
          <p>${q.text}</p>
          <div class="options">
            ${q.options.map((opt, i) =>
              `<label>
                 <input type="radio" name="q${idx}" value="${i}">
                 ${opt}
               </label>`
            ).join('')}
          </div>
        `;
        form.appendChild(field);
      });

      // Gestione invio
      document.getElementById('submit-button').addEventListener('click', () => {
        let correct = 0;
        selected.forEach((q, idx) => {
          const val = form.querySelector(`input[name="q${idx}"]:checked`);
          if (val && parseInt(val.value, 10) === q.correct) correct++;
        });

        const score = Math.round((correct / selected.length) * 30);
        let outcome;
        if (score === 18) outcome = "Passato con disonore";
        else if (score >= 18) outcome = "Esame superato";
        else outcome = "Esame non superato";

        const resultEl = document.getElementById('result');
        resultEl.innerText =
          `Hai risposto correttamente a ${correct} su ${selected.length}.\n` +
          `Voto finale: ${score}/30\n` +
          `${outcome}`;
        resultEl.style.display = 'block';

        form.querySelectorAll('input').forEach(i => i.disabled = true);
        document.getElementById('submit-button').disabled = true;
      });
    });
  </script>

</body>
</html>
