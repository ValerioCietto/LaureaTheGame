<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Esame dinamico</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 40px auto;
      line-height: 1.5;
    }
    h1, h2 {
      text-align: center;
    }
    #exam-text p {
      background: #f0f8ff;
      padding: 10px;
      border-left: 4px solid #268bd2;
      margin: 0 0 1em;
    }
    .question {
      margin-bottom: 1.2em;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .options label {
      display: block;
      margin: 4px 0;
      padding: 4px;
      border-radius: 4px;
    }
    .options label.correct {
      background-color: #c8e6c9; /* verde chiaro */
    }
    .options label.wrong {
      background-color: #ffcdd2; /* rosso chiaro */
    }
    #submit-button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1em;
    }
    #result {
      text-align: center;
      font-size: 1.2em;
      margin-top: 30px;
      padding: 20px;
      border: 2px solid #268bd2;
      border-radius: 8px;
      background: #eef9ff;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h1 id="exam-title">Esame</h1>
  <p style="text-align:center;">
    CFU assegnati: <span id="cfu-display">–</span> &nbsp;|&nbsp;
    Preparazione: <span id="prep-display">–</span> paragrafi
  </p>

  <div id="exam-text"></div>

  <form id="exam-form"></form>
  <button id="submit-button">Invia risposte</button>

  <div id="result" style="display:none;"></div>

  <script>
    function getParam(name, defaultValue = null) {
      const params = new URL(window.location).searchParams;
      return params.has(name) ? params.get(name) : defaultValue;
    }
    function getParamNum(name, defaultValue) {
      const v = parseInt(getParam(name), 10);
      return isNaN(v) ? defaultValue : v;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Parametri aggiuntivi
      const bonus = getParamNum('bonus_voto', 0);
      const hint = getParam('hint', 'false') === 'true';
      const copiaDa = getParam('copia_da', '').toLowerCase();
      const allaCieca = getParam('alla_cieca', 'false') === 'true';

      const nomeEsame = getParam('nome_esame', null);
      if (!nomeEsame) {
        document.body.innerHTML = "<p style='color:red;text-align:center;'>Parametro <strong>nome_esame</strong> mancante!</p>";
        return;
      }

      let examData;
      try {
        const res = await fetch(`esami/${nomeEsame}.json`);
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        examData = await res.json();
      } catch (err) {
        document.body.innerHTML = `<p style='color:red;text-align:center;'>Impossibile caricare l'esame "${nomeEsame}":<br>${err.message}</p>`;
        return;
      }

      const prep = Math.min(4, Math.max(1, getParamNum('preparazione', 1)));
      const cfuParam = getParamNum('cfu', examData.cfu || 0);
      examData.cfu = cfuParam;

      document.getElementById('exam-title').innerText = `Esame: ${examData.name}`;
      document.getElementById('cfu-display').innerText = examData.cfu;
      document.getElementById('prep-display').innerText = prep;

      // Testo
      const textContainer = document.getElementById('exam-text');
      examData.text.slice(0, prep).forEach(p => {
        const pEl = document.createElement('p');
        pEl.textContent = p;
        textContainer.appendChild(pEl);
      });

      // Domande
      const selected = shuffle([...examData.questions]).slice(0, 5);
      const form = document.getElementById('exam-form');

      selected.forEach((q, idx) => {
        const field = document.createElement('div');
        field.className = 'question';
        // Question text
        const qText = document.createElement('p');
        if (!allaCieca) {
          const prefix = hint ? `Dal paragrafo ${q.paragraph + 1}: ` : '';
          qText.textContent = prefix + q.text;
        } else {
          qText.style.visibility = 'hidden';
        }
        field.appendChild(qText);
        // Options
        const optsDiv = document.createElement('div');
        optsDiv.className = 'options';
        q.options.forEach((opt, i) => {
          const label = document.createElement('label');
          label.setAttribute('data-q', idx);
          label.setAttribute('data-i', i);
          label.style.textDecoration = 'none';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `q${idx}`;
          input.value = i;
          label.appendChild(input);
          label.appendChild(document.createTextNode(' ' + opt));
          optsDiv.appendChild(label);
        });
        field.appendChild(optsDiv);
        form.appendChild(field);
      });

      // Sottolineature copia_da
      selected.forEach((q, idx) => {
        const labels = Array.from(form.querySelectorAll(`label[data-q="${idx}"]`));
        if (copiaDa === 'esperto') {
          labels.forEach(label => {
            if (parseInt(label.getAttribute('data-i'), 10) === q.correct) {
              label.style.textDecoration = 'underline';
            }
          });
        } else if (copiaDa === 'mediocre') {
          labels.forEach(label => label.style.textDecoration = 'none');
          if (Math.random() < 0.5) {
            // underline correct
            const corr = labels.find(l => parseInt(l.getAttribute('data-i'),10) === q.correct);
            if (corr) corr.style.textDecoration = 'underline';
          } else {
            // underline a random wrong
            const wrongs = labels.filter(l => parseInt(l.getAttribute('data-i'),10) !== q.correct);
            const pick = wrongs[Math.floor(Math.random()*wrongs.length)];
            if (pick) pick.style.textDecoration = 'underline';
          }
        } else if (copiaDa === 'scarso') {
          const pick = labels[Math.floor(Math.random()*labels.length)];
          if (pick) pick.style.textDecoration = 'underline';
        }
      });

      // Invio risposte
      document.getElementById('submit-button').addEventListener('click', () => {
        let correctCount = 0;
        selected.forEach((q, idx) => {
          const chosen = form.querySelector(`input[name="q${idx}"]:checked`);
          const val = chosen ? parseInt(chosen.value, 10) : null;
          if (val === q.correct) correctCount++;
          // evidenzia corrette/errate
          form.querySelectorAll(`label[data-q="${idx}"]`).forEach(label => {
            const i = parseInt(label.getAttribute('data-i'),10);
            label.classList.remove('correct','wrong');
            if (i === q.correct) label.classList.add('correct');
            if (i === val && val !== q.correct) label.classList.add('wrong');
          });
        });

        const baseScore = Math.round((correctCount / selected.length) * 30);
        let finalScore = baseScore + bonus;
        if (finalScore < 1) finalScore = 1;
        if (finalScore > 30) finalScore = 30;

        let outcomeText;
        if (finalScore === 18) outcomeText = "Passato con disonore";
        else if (finalScore >= 18) outcomeText = "Esame superato";
        else outcomeText = "Esame non superato";

        const resultEl = document.getElementById('result');
        resultEl.innerText =
          `Hai risposto correttamente a ${correctCount} su ${selected.length}.\n` +
          `Voto base: ${baseScore}/30  (bonus ${bonus >= 0 ? '+'+bonus : bonus})\n` +
          `Voto finale: ${finalScore}/30\n` +
          outcomeText;
        resultEl.style.display = 'block';

        form.querySelectorAll('input').forEach(i => i.disabled = true);
        document.getElementById('submit-button').disabled = true;
      });
    });
  </script>

</body>
</html>
